<div class="media-container">
  <h1>Média Böngésző</h1>

  @if (error()) {
    <div class="error-banner">
      {{ error() }}
      <button (click)="loadCameras()">Újrapróbálás</button>
    </div>
  }

  @if (aiStatus()?.enabled && !aiStatus()?.modelExists) {
    <div class="warning-banner ai-model-warning">
      <strong>AI Figyelmeztetés:</strong> Az AI engedélyezve van, de a modell fájl hiányzik:
      <code>{{ aiStatus()?.modelPath }}</code>
      <br>
      Kérjük, töltse le a modellt a szerverre a funkció használatához.
    </div>
  }

  <div class="controls">
    <div class="control-group">
      <label for="camera-select">Kamera:</label>
      <select id="camera-select" (change)="onCameraChange($event)">
        <option value="">Válassz kamerát...</option>
        @for (camera of cameras(); track camera) {
          <option [value]="camera">{{ camera }}</option>
        }
      </select>
    </div>

    @if (selectedCamera()) {
      <div class="control-group">
        <label for="date-select">Dátum:</label>
        <select id="date-select" (change)="onDateChange($event)">
          <option value="">Válassz dátumot...</option>
          @for (date of dates(); track date) {
            <option [value]="date">{{ date }}</option>
          }
        </select>
      </div>
    }
  </div>

  <div class="main-content">
    <div class="video-list-section">
      <h3>Videók @if (loading()) { <span class="loading-spinner">...</span> }</h3>

      @if (selectedDate() && videos().length === 0 && !loading()) {
        <p>Nincs videó ezen a napon.</p>
      }

      <ul class="video-list">
        @for (video of videos(); track video.relativePath) {
          <li
            [class.selected]="selectedVideo()?.file === video.file"
            (click)="selectVideo(video)"
          >
            <div class="thumbnail-container">
              @if (thumbnailStates()[video.relativePath] === 'loading') {
                <div class="thumbnail-overlay">
                  <div class="spinner"></div>
                </div>
              }
              @if (thumbnailStates()[video.relativePath] === 'error') {
                <div class="thumbnail-overlay error">
                  <span class="error-text">Nincs előnézet</span>
                </div>
              }
              <img
                [src]="getThumbnailUrl(video.relativePath)"
                [class.visible]="thumbnailStates()[video.relativePath] === 'loaded'"
                loading="lazy"
                alt="Előnézet"
                (load)="onThumbnailLoad(video.relativePath)"
                (error)="onThumbnailError(video.relativePath)"
              >
            </div>
            <div class="video-info">
              <span class="time">{{ video.time }}</span>
              <div class="label-container">
                @if (video.label?.topLabel) {
                  <span class="badge" [class]="video.label!.topLabel.toLowerCase()">
                    {{ video.label!.topLabel }}
                  </span>
                } @else if (analyzing()[video.relativePath]) {
                  <span class="badge analyzing">Analyzing...</span>
                } @else if (aiErrors()[video.relativePath]) {
                  <span class="badge error" (click)="$event.stopPropagation(); triggerAnalysis(video.relativePath)" title="Kattints az újrapróbáláshoz">
                    {{ aiErrors()[video.relativePath] }}
                  </span>
                }
              </div>
              <span class="filename">{{ video.file }}</span>
            </div>
          </li>
        }
      </ul>
    </div>

    <div class="player-section">
      @if (videoUrl()) {
        <div class="video-player-container">
          <h4>{{ selectedVideo()?.time }} - {{ selectedVideo()?.file }}</h4>
          <video
            controls
            autoplay
            [src]="videoUrl()"
          >
            Sajnos a böngésződ nem támogatja a videó lejátszást.
          </video>
        </div>
      } @else {
        <div class="player-placeholder">
          <p>Válassz egy videót a listából a lejátszáshoz.</p>
        </div>
      }
    </div>
  </div>
</div>
