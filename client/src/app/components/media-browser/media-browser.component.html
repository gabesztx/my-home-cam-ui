<div class="media-container">
  <h1>Média Böngésző</h1>

  @if (error()) {
    <div class="error-banner">
      {{ error() }}
      <button (click)="loadCameras()">Újrapróbálás</button>
    </div>
  }

  <div class="controls">
    <div class="control-group">
      <label for="camera-select">Kamera:</label>
      <select id="camera-select" (change)="onCameraChange($event)">
        <option value="">Válassz kamerát...</option>
        @for (camera of cameras(); track camera) {
          <option [value]="camera">{{ camera }}</option>
        }
      </select>
    </div>

    @if (selectedCamera()) {
      <div class="control-group">
        <label for="date-select">Dátum:</label>
        <select id="date-select" (change)="onDateChange($event)">
          <option value="">Válassz dátumot...</option>
          @for (date of dates(); track date) {
            <option [value]="date">{{ date }}</option>
          }
        </select>
      </div>
    }
  </div>

  <div class="main-content">
    <div class="video-list-section">
      <div class="video-list-header">
        <h3>Videók @if (loading()) { <span class="loading-spinner">...</span> }</h3>
        @if (videos().length > 0) {
          <button class="refresh-labels-btn" (click)="refreshLabels()">Refresh labels</button>
        }
      </div>

      @if (selectedDate() && videos().length === 0 && !loading()) {
        <p>Nincs videó ezen a napon.</p>
      }

      <ul class="video-list">
        @for (video of videos(); track video.relativePath) {
          <li
            [class.selected]="selectedVideo()?.file === video.file"
            (click)="selectVideo(video)"
          >
            <div class="thumbnail-container">
              @if (thumbnailStates()[video.relativePath] === 'loading') {
                <div class="thumbnail-overlay">
                  <div class="spinner"></div>
                </div>
              }
              @if (thumbnailStates()[video.relativePath] === 'error') {
                <div class="thumbnail-overlay error">
                  <span class="error-text">Nincs előnézet</span>
                </div>
              }
              <img
                [src]="getThumbnailUrl(video.relativePath)"
                [class.visible]="thumbnailStates()[video.relativePath] === 'loaded'"
                loading="lazy"
                alt="Előnézet"
                (load)="onThumbnailLoad(video.relativePath)"
                (error)="onThumbnailError(video.relativePath)"
              >
            </div>
            <div class="video-info">
              <span class="time">{{ video.time }}</span>
              <span class="filename">{{ video.file }}</span>
              @if (video.label) {
                <span class="label-badge" [ngClass]="getLabelBadgeClass(video.label.topLabel)">
                  {{ getLabelText(video.label.topLabel) }}
                </span>
              } @else if (labelStates()[video.relativePath] === 'analyzing') {
                <span class="label-badge badge-analyzing" (click)="$event.stopPropagation()">
                  Analyzing...
                </span>
              } @else {
                <span class="label-badge badge-trigger" (click)="triggerLabelIfNeeded(video); $event.stopPropagation()">
                  Analyze
                </span>
              }
            </div>
          </li>
        }
      </ul>
    </div>

    <div class="player-section">
      @if (videoUrl()) {
        <div class="video-player-container">
          <h4>{{ selectedVideo()?.time }} - {{ selectedVideo()?.file }}</h4>
          <video
            controls
            autoplay
            [src]="videoUrl()"
          >
            Sajnos a böngésződ nem támogatja a videó lejátszást.
          </video>
        </div>
      } @else {
        <div class="player-placeholder">
          <p>Válassz egy videót a listából a lejátszáshoz.</p>
        </div>
      }
    </div>
  </div>
</div>
